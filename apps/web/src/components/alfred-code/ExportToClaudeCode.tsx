'use client';

/**
 * Export Project Component
 *
 * One-click export for power users who want to use the project locally.
 * Downloads project as ZIP - user can run: cd project && npm run dev
 *
 * Zero infrastructure. It just works.
 */

import { useState } from 'react';
import JSZip from 'jszip';

// ═══════════════════════════════════════════════════════════════════════════════
// TYPES
// ═══════════════════════════════════════════════════════════════════════════════

interface ExportToClaudeCodeProps {
  files: Map<string, string>;
  projectName: string;
  dependencies?: Record<string, string>;
  devDependencies?: Record<string, string>;
  className?: string;
}

// ═══════════════════════════════════════════════════════════════════════════════
// ICONS
// ═══════════════════════════════════════════════════════════════════════════════

const TerminalIcon = (
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <polyline points="4 17 10 11 4 5"/>
    <line x1="12" y1="19" x2="20" y2="19"/>
  </svg>
);

const DownloadIcon = (
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
    <polyline points="7 10 12 15 17 10"/>
    <line x1="12" y1="15" x2="12" y2="3"/>
  </svg>
);

const CheckIcon = (
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
    <polyline points="20 6 9 17 4 12"/>
  </svg>
);

// ═══════════════════════════════════════════════════════════════════════════════
// COMPONENT
// ═══════════════════════════════════════════════════════════════════════════════

export function ExportToClaudeCode({
  files,
  projectName,
  dependencies = {},
  devDependencies = {},
  className = '',
}: ExportToClaudeCodeProps) {
  const [isExporting, setIsExporting] = useState(false);
  const [exportComplete, setExportComplete] = useState(false);

  const handleExport = async () => {
    if (files.size === 0) {
      console.warn('[Export] No files to export');
      return;
    }

    setIsExporting(true);
    setExportComplete(false);

    try {
      const zip = new JSZip();
      const safeName = projectName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') || 'project';

      // Add all project files
      files.forEach((content, path) => {
        // Remove leading slash for zip path
        const filePath = path.startsWith('/') ? path.slice(1) : path;
        zip.file(filePath, content);
      });

      // Create package.json if it doesn't exist
      if (!files.has('/package.json')) {
        const packageJson = {
          name: safeName,
          version: '0.1.0',
          private: true,
          scripts: {
            dev: 'vite',
            build: 'tsc && vite build',
            preview: 'vite preview',
          },
          dependencies: {
            react: '^18.2.0',
            'react-dom': '^18.2.0',
            ...dependencies,
          },
          devDependencies: {
            '@types/react': '^18.2.0',
            '@types/react-dom': '^18.2.0',
            '@vitejs/plugin-react': '^4.2.0',
            typescript: '^5.3.0',
            vite: '^5.0.0',
            ...devDependencies,
          },
        };
        zip.file('package.json', JSON.stringify(packageJson, null, 2));
      }

      // Add helpful README
      zip.file('README.md', `# ${projectName}

Generated by Alfred Pro Builder.

## Quick Start

\`\`\`bash
cd ${safeName}
npm install
npm run dev
\`\`\`

## Continue with Alfred

For continued AI-powered code modifications, open this project in Alfred Builder.

---

Built with Alfred Pro Builder
`);

      // Add .gitignore
      if (!files.has('/.gitignore')) {
        zip.file('.gitignore', `node_modules
dist
.env
.env.local
*.log
.DS_Store
`);
      }

      // Generate and download
      const blob = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${safeName}.zip`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      setExportComplete(true);
      console.log(`[Export] Downloaded ${safeName}.zip with ${files.size} files`);

      // Reset after 3 seconds
      setTimeout(() => {
        setExportComplete(false);
      }, 3000);
    } catch (error) {
      console.error('[Export] Failed:', error);
    } finally {
      setIsExporting(false);
    }
  };

  return (
    <button
      onClick={handleExport}
      disabled={isExporting || files.size === 0}
      className={`
        flex items-center gap-2 px-3 py-2
        bg-slate-800 hover:bg-slate-700
        border border-slate-700 hover:border-slate-600
        rounded-lg text-sm text-slate-300
        transition-all duration-200
        disabled:opacity-50 disabled:cursor-not-allowed
        ${exportComplete ? 'bg-green-900/30 border-green-700 text-green-400' : ''}
        ${className}
      `}
      title="Download project as ZIP"
    >
      {exportComplete ? (
        <>
          {CheckIcon}
          Downloaded!
        </>
      ) : isExporting ? (
        <>
          <svg className="animate-spin w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <circle cx="12" cy="12" r="10" opacity="0.25"/>
            <path d="M12 2a10 10 0 019.5 13" strokeLinecap="round"/>
          </svg>
          Exporting...
        </>
      ) : (
        <>
          {DownloadIcon}
          <span className="hidden sm:inline">Export Project</span>
          <span className="sm:hidden">{DownloadIcon}</span>
        </>
      )}
    </button>
  );
}

export default ExportToClaudeCode;
