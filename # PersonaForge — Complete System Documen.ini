# PersonaForge â€” Complete System Documentation

> **Last Updated:** January 5, 2026  
> **Branch:** `feature/personaforge` (local)  
> **Location:** `~/AlfredV0.1/apps/web/src/app/personas/`

---

## ðŸ“‹ Table of Contents

1. [Overview](#overview)
2. [Architecture](#architecture)
3. [Backend Capabilities](#backend-capabilities)
4. [Frontend Components](#frontend-components)
5. [API Routes](#api-routes)
6. [Database Schema](#database-schema)
7. [Environment Variables](#environment-variables)
8. [File Locations](#file-locations)
9. [Design System](#design-system)
10. [Current Status](#current-status)
11. [Known Issues & Fixes](#known-issues--fixes)
12. [Future Roadmap](#future-roadmap)

---

## Overview

PersonaForge is an AI character creation system within the Alfred platform. Users create AI personas with:
- Custom appearance (AI-generated images)
- Unique voice (ElevenLabs)
- Personality traits (Big Five / OCEAN model)
- Memory and emotional intelligence
- Video generation capabilities

**The WOW Factor:** A cinematic "Awakening Ceremony" where particles coalesce into the persona's form, eyes open, and they speak their first words.

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ALFRED PLATFORM                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  apps/web/                    packages/                          â”‚
â”‚  â”œâ”€â”€ src/app/personas/        â”œâ”€â”€ persona/     â† Core logic      â”‚
â”‚  â”‚   â”œâ”€â”€ page.tsx             â”‚   â”œâ”€â”€ awakening.ts               â”‚
â”‚  â”‚   â”œâ”€â”€ AwakeningScene.tsx   â”‚   â”œâ”€â”€ genome/                    â”‚
â”‚  â”‚   â””â”€â”€ EngageView.tsx       â”‚   â”‚   â””â”€â”€ types.ts               â”‚
â”‚  â”‚                            â”‚   â”œâ”€â”€ voice/                     â”‚
â”‚  â””â”€â”€ src/app/api/personas/    â”‚   â””â”€â”€ memory/                    â”‚
â”‚      â”œâ”€â”€ route.ts             â”œâ”€â”€ db/          â† Prisma          â”‚
â”‚      â””â”€â”€ [id]/                â””â”€â”€ ai/          â† AI providers    â”‚
â”‚          â”œâ”€â”€ route.ts                                            â”‚
â”‚          â”œâ”€â”€ chat/route.ts                                       â”‚
â”‚          â””â”€â”€ wizard/route.ts                                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Backend Capabilities

### Persona Genome System (`packages/persona/src/genome/types.ts`)

The PersonaGenome is an 800+ line type definition containing:

#### Visual DNA
```typescript
{
  faceEmbedding: number[512],     // Identity consistency
  stylePreset: StylePreset,       // hyper_realistic | pixar_3d | anime_premium | etc.
  expressions: Expression[22],    // Pre-rendered emotion grid
  colorPalette: ColorPalette,     // Derived from appearance
  visualSignature: {
    auraColor: string,
    accentColor: string,
    particleStyle: "sparkle" | "mist" | "flame" | "crystal" | "shadow" | "light",
    glowIntensity: number
  }
}
```

#### Voice DNA
```typescript
{
  provider: "elevenlabs",
  voiceId: string,
  settings: {
    stability: number,
    similarityBoost: number,
    style: number,
    speakerBoost: boolean
  },
  ssmlCapabilities: boolean,
  emotionalRange: EmotionMapping
}
```

#### Motion DNA
```typescript
{
  idleAnimations: Animation[],
  gestures: GestureMap,
  expressionTransitions: TransitionTiming,
  blinkRate: number,
  breathingPattern: BreathingConfig
}
```

#### Mind DNA (Big Five / OCEAN)
```typescript
{
  openness: number,        // 0-1
  conscientiousness: number,
  extraversion: number,
  agreeableness: number,
  neuroticism: number,
  
  communicationStyle: "formal" | "casual" | "friendly" | "professional",
  vocabularyLevel: "simple" | "moderate" | "sophisticated",
  humorStyle: "dry" | "playful" | "sarcastic" | "warm",
  traits: string[]         // User-selected traits
}
```

### Awakening Ceremony (`packages/persona/src/awakening.ts`)

3-stage birth sequence:
1. **Emergence** â€” Particles form from void
2. **Awakening** â€” Eyes open, consciousness stirs
3. **Introduction** â€” First words spoken (archetype-contextual)

**Cost:** ~$0.32 per awakening ceremony

### 12 Archetypes

| Archetype | Essence | Aura Color |
|-----------|---------|------------|
| Sage | Wisdom | Blue/Gold |
| Hero | Courage | Red/Steel |
| Creator | Vision | Cyan/Gold |
| Caregiver | Compassion | Green/Silver |
| Ruler | Power | Crimson/Gold |
| Jester | Joy | Purple/Cyan |
| Rebel | Freedom | Orange/Gold |
| Lover | Passion | Pink/Rose |
| Explorer | Discovery | Green/Amber |
| Innocent | Hope | Sky Blue/White |
| Magician | Transformation | Indigo/Lavender |
| Outlaw | Liberation | Dark/Crimson |

### 6 Visual Styles

1. `hyper_realistic` â€” Photorealistic rendering
2. `pixar_3d` â€” Pixar-style 3D animation
3. `anime_premium` â€” High-quality anime
4. `fantasy_epic` â€” Fantasy/mythical style
5. `arcane_stylized` â€” Arcane/League of Legends style
6. `corporate_professional` â€” Business headshots

### Image Generation Pipeline

Triple fallback chain:
1. **RunPod** (Primary) â€” GPU instances, custom models
2. **Replicate** (Backup) â€” Hosted inference
3. **Stability AI** (Fallback) â€” Stable Diffusion API

---

## Frontend Components

### page.tsx (Main Entry)
- **Lines:** ~2000
- **Views:** home, create, awakening, persona, video

#### HomeView
- Empty state with dramatic typography
- Persona gallery grid
- Each card has: Avatar, Name, Archetype, Video button, Chat button

#### CreateFlow (5-step wizard)
| Step | Purpose | API Action |
|------|---------|------------|
| 0 | Name + Archetype | `POST /api/personas` â†’ `start` â†’ `spark` |
| 1 | Visual Style | â€” |
| 2 | Image Selection | `generate-variations` â†’ `lock-identity` |
| 3 | Personality Traits | `configure-mind` â†’ `finalize` |

#### PersonaView
- Chat interface with persona
- Real-time messaging
- Typing indicators

#### VideoStudio
- Script input panel
- Video preview panel
- Generate & Download buttons

### AwakeningScene.tsx (Three.js Ceremony)
- **Lines:** ~500
- **Dependencies:** `@react-three/fiber`, `@react-three/drei`, `@react-three/postprocessing`

#### Stages
| Stage | Time | Visual |
|-------|------|--------|
| 0 - Void | 0-1s | Pure darkness, faint particles |
| 1 - Emergence | 1-3s | Particles spiral inward |
| 2 - Coalescence | 3-5s | Humanoid silhouette forms |
| 3 - Awakening | 5-7s | Avatar materializes, glow effects |
| 4 - Introduction | 7-10s | Name + first words appear |

#### Effects
- 1500 particles with additive blending
- Bloom post-processing
- Vignette
- Aura ring with pulse animation
- Avatar with breathing animation

### EngageView.tsx
- Full engagement interface (separate from chat)
- Living portrait with expressions
- Advanced interaction modes

---

## API Routes

### `/api/personas`
| Method | Purpose |
|--------|---------|
| GET | List all personas for user |
| POST | Create new persona (requires: name, archetype, description) |

### `/api/personas/[id]`
| Method | Purpose |
|--------|---------|
| GET | Get single persona |
| PUT | Update persona |
| DELETE | Delete persona |

### `/api/personas/[id]/chat`
| Method | Purpose |
|--------|---------|
| POST | Send message, get AI response |

**Required:** `credentials: "include"` in fetch

### `/api/personas/[id]/wizard`
| Method | Purpose |
|--------|---------|
| POST | Execute wizard action |

#### Wizard Actions
```typescript
type WizardAction = 
  | "start"              // Initialize wizard session
  | "spark"              // Set initial identity (name, description, archetype)
  | "generate-variations"// Generate 4 image options
  | "lock-identity"      // Lock chosen image, extract face embedding
  | "configure-voice"    // Set voice settings
  | "configure-mind"     // Set personality traits
  | "finalize"           // Complete persona creation
```

---

## Database Schema

```prisma
model Persona {
  id          String   @id @default(uuid())
  userId      String
  name        String
  description String
  archetype   String
  traits      String[] 
  imageUrl    String?
  voiceId     String?
  genome      Json?    // Full PersonaGenome
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id])
  messages    PersonaMessage[]
}

model PersonaMessage {
  id        String   @id @default(uuid())
  personaId String
  role      String   // "user" | "assistant"
  content   String
  emotion   String?  // Detected/expressed emotion
  createdAt DateTime @default(now())
  
  persona   Persona  @relation(fields: [personaId], references: [id])
}
```

---

## Environment Variables

Add to `apps/web/.env.local`:

```bash
# AI Providers
ANTHROPIC_API_KEY=           # Claude for personality/chat
STABILITY_API_KEY=           # Image generation (primary)
REPLICATE_API_TOKEN=         # Image generation (backup)
RUNPOD_API_KEY=              # GPU instances (optional)

# Voice
ELEVENLABS_API_KEY=          # Voice synthesis

# Demo Mode (set in page.tsx)
# const DEMO_MODE = true     # Bypasses all API calls for testing
```

---

## File Locations

```
~/AlfredV0.1/
â”œâ”€â”€ apps/web/
â”‚   â”œâ”€â”€ src/app/
â”‚   â”‚   â”œâ”€â”€ personas/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx              # Main UI (2000+ lines)
â”‚   â”‚   â”‚   â”œâ”€â”€ AwakeningScene.tsx    # Three.js ceremony
â”‚   â”‚   â”‚   â””â”€â”€ EngageView.tsx        # Engagement interface
â”‚   â”‚   â””â”€â”€ api/personas/
â”‚   â”‚       â”œâ”€â”€ route.ts              # List/Create
â”‚   â”‚       â””â”€â”€ [id]/
â”‚   â”‚           â”œâ”€â”€ route.ts          # CRUD
â”‚   â”‚           â”œâ”€â”€ chat/route.ts     # Chat endpoint
â”‚   â”‚           â””â”€â”€ wizard/route.ts   # Creation wizard
â”‚   â””â”€â”€ .env.local                    # API keys
â”‚
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ persona/
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ awakening.ts          # Ceremony logic
â”‚   â”‚   â”‚   â”œâ”€â”€ genome/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ types.ts          # 800+ line type defs
â”‚   â”‚   â”‚   â”œâ”€â”€ voice/                # ElevenLabs integration
â”‚   â”‚   â”‚   â””â”€â”€ memory/               # Persona memory system
â”‚   â”‚   â””â”€â”€ dist/                     # Compiled output
â”‚   â”œâ”€â”€ db/                           # Prisma schema
â”‚   â””â”€â”€ ai/                           # AI provider abstractions
â”‚
â””â”€â”€ /mnt/transcripts/
    â””â”€â”€ journal.txt                   # Development log
```

---

## Design System

### Monochrome Palette
```typescript
const c = {
  // Blacks
  void: "#000000",
  ink: "#0a0a0a",
  coal: "#111111",
  graphite: "#1a1a1a",
  
  // Grays
  steel: "#2a2a2a",
  silver: "#888888",
  mist: "#aaaaaa",
  
  // Whites
  pearl: "#e0e0e0",
  snow: "#f5f5f5",
  white: "#ffffff",
  
  // Functional
  glass: "rgba(255,255,255,0.03)",
  border: "rgba(255,255,255,0.08)",
  borderLight: "rgba(255,255,255,0.15)",
};
```

### Typography
- Font: SF Pro Display / system fonts
- Headings: Weight 200-300 (light/thin)
- Body: Weight 400-500
- Large display text: `clamp(32px, 6vw, 48px)`

### Animation Philosophy
- Subtle, intentional motion
- Spring physics where appropriate
- Framer Motion for UI
- Three.js for 3D effects
- No excessive flourishes

---

## Current Status

### âœ… Working Now
- [x] Full creation wizard UI
- [x] Persona gallery with cards
- [x] Awakening ceremony (Three.js)
- [x] Video Studio UI
- [x] Chat interface
- [x] DEMO_MODE for testing
- [x] All API routes defined
- [x] Backend genome system
- [x] 12 archetypes
- [x] 6 visual styles

### â³ Needs API Credits
- [ ] AI image generation (Stability/Replicate/RunPod)
- [ ] ElevenLabs voice synthesis
- [ ] Claude chat responses
- [ ] Face embedding extraction

### âš ï¸ Known Issues
- Chat 401 error â†’ Add `credentials: "include"` to fetch
- Description required â†’ Frontend now provides default

---

## Known Issues & Fixes

### Issue: Chat returns 401 Unauthorized
**Fix:** Add credentials to fetch:
```typescript
const res = await fetch(`/api/personas/${persona.id}/chat`, {
  method: "POST",
  credentials: "include",  // â† Add this
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ message: userMessage }),
});
```

### Issue: "Description is required" error
**Fix:** Frontend now auto-generates:
```typescript
const finalDescription = description.trim() || 
  `A ${archetype} persona named ${name}`;
```

### Issue: Three.js SSR errors
**Fix:** Dynamic import with ssr: false:
```typescript
const AwakeningScene = dynamic(() => import("./AwakeningScene"), { 
  ssr: false 
});
```

---

## Future Roadmap

### Phase 1: Core Completion
- [ ] Fix chat 401 authentication
- [ ] Connect real image generation
- [ ] Add voice preview in wizard
- [ ] Expression grid viewer

### Phase 2: Enhancement
- [ ] Multiple personas in conversation
- [ ] Persona-to-persona chat
- [ ] Video export with lip sync
- [ ] Memory visualization

### Phase 3: Advanced
- [ ] Real-time video calling
- [ ] AR/VR avatar projection
- [ ] Multi-language support
- [ ] Persona marketplace

---

## Quick Start Commands

```bash
# Navigate to project
cd ~/AlfredV0.1

# Switch to branch
git checkout feature/personaforge

# Install dependencies
pnpm install

# Add Three.js packages (if needed)
cd apps/web && pnpm add @react-three/fiber@8.15.0 @react-three/drei@9.88.0 @react-three/postprocessing@2.15.0 three@0.149.0 postprocessing@6.33.0

# Run dev server
cd ~/AlfredV0.1 && pnpm dev

# Visit
open http://localhost:3005/personas
```

---

## Commit History

```
47538a7 feat(personas): State-of-the-art immersive UI
        - Full-screen immersive creation flow
        - Monochrome black/white elegant design
        - Awakening ceremony with Three.js particles
        - Video Studio for persona videos
        - Chat interface
        - DEMO_MODE for testing
        - All backend capabilities wired up
```

---

## Contact & Credits

**Built by:** Derp (with Claude)  
**Platform:** Alfred V0.1  
**Design Philosophy:** Steve Jobs level elegance, Leonardo da Vinci craftsmanship

---

*"Ostinato Rigore" â€” Stubborn Rigor*